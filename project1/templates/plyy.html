{% extends "base.html" %}

{% block content %}
    <div>
        <div class="plyy_title_box">
            <div id="plyy_title"></div>
            <div id="line"></div>
        </div>
            <div id="info">
                <div id="date"></div>
                <div id="curator"></div>
                <div id="total"></div>
                <div id="heart"></div>
            </div>
            <div class="plyy_container">
                <div id="tag_container"></div>
                <div id="comment" class="comment"></div>
                <hr style="border:0px; height:4px; background:#F15A22; width: 100%;">
                <li class="pointer" id="tracks"></li>
            </div>
    </div>
{% endblock %}

{% block script %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let url = window.location.href;
            url = url.split('/');
            let plyyId = url[url.length - 1];
            fetchPlyyDetail(plyyId);
        });
        
        function fetchPlyyDetail(plyyId) {
            fetch(`/api/plyy/${plyyId}`)
            .then(response =>  response.json())
            .then(data => {
                total_rtime = 0;
                document.title = data.plyy.title + ' | PLYY';
                const plyy_title = document.getElementById('plyy_title');
                const date = document.getElementById('date');
                const curator = document.getElementById('curator');
                const heart = document.getElementById('heart');
                const total = document.getElementById('total');
                const tagContainer = document.getElementById('tag_container');
                const comment = document.getElementById('comment');
                console.log(plyy_title)
                console.log(comment)
                plyy_title.textContent = data.plyy.title;
                if (data.plyy.update) {
                    date.innerHTML  = '수정일 : ' + data.plyy.update.replace(/-/g, '.');
                } else {
                    date.innerHTML  = '발행일 : ' + data.plyy.generate.replace(/-/g, '.');
                }
                curator.innerHTML = '<p>큐레이터 : ' + data.plyy.curator + '</p>';
                heart.innerHTML = '<img src="/static/source/heart_white.svg">' + data.plyy.heart;
                comment.textContent = data.plyy.comment;
                const genre = document.createElement('span');
                genre.textContent = '#' + data.plyy.genre;
                tagContainer.appendChild(genre);
                data.tags.forEach(data => {
                    const tag = document.createElement('span');
                    tag.textContent = '#' + data.name;
                    tagContainer.appendChild(tag);
                });
                const lst = document.getElementById('tracks')
                data.tracks.forEach(track => {
                    const newItem = document.createElement('ul');
                    newItem.innerHTML = 
                        `<div onclick="location.href='./${plyyId}/${parseInt(track.num) + 1}'">` +
                            '<div>' +
                                '<div>' + `<img src="${track.img}">` +
                                    '<div>' + 
                                        '<b>' + '<p lang="ko">' + `${track.title}` + '</p>' + '</b>' +
                                        '<p lang="ko">' + `${track.artist}` + '</p>' +
                                    '</div>' +
                                '</div>' +
                                    '<div>' + `${String(song_time(track.rtime))}` + '</div>' +
                            '</div>' +
                        '</div>';
                    lst.appendChild(newItem);
                    total_rtime = total_rtime + parseInt(track.rtime);
                })
                total.innerHTML = data.tracks.length + '곡 | ' + plyy_time(total_rtime);
            })
            .catch(error => console.error('데이터를 처리하는 과정에서 오류가 발생하였습니다.'))
        };

        </script>
        <script src="/static/js/runtime.js"></script>
{% endblock %}